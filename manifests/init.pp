# Class: squid3
#
# Squid 3.x proxy server.
#
# Sample Usage :
#     include squid3
#
#     class { 'squid3':
#       acl => [
#         'de myip 192.168.1.1',
#         'fr myip 192.168.1.2',
#         'office src 10.0.0.0/24',
#       ],
#       http_access => [
#         'allow office',
#       ],
#       cache => [ 'deny all' ],
#       via => 'off',
#       tcp_outgoing_address => [
#         '192.168.1.1 country_de',
#         '192.168.1.2 country_fr',
#       ],
#       server_persistent_connections => 'off',
#     }
#
class squid3 (
  # Options are in the same order they appear in squid.conf
  #$http_port            = [ '3128' ],
  #$acl                  = [],
  #$http_access          = [],
  #$icp_access           = [],
  #$tcp_outgoing_address = [],
  #$cache_mem            = '256 MB',
  #$cache_dir            = [],
  #$cache                = [],
  #$via                  = 'on',
  #$ignore_expect_100    = 'off',
  #$cache_mgr            = 'root',
  #$forwarded_for        = 'on',
  #$client_persistent_connections = 'on',
  #$server_persistent_connections = 'on',
  #$maximum_object_size           = '4096 KB',
  #$maximum_object_size_in_memory = '512 KB',
  #$config_hash          = {},
  #$refresh_patterns     = [],
  #$template             = 'long',
  #$hierarchy_stoplist   = [],
  #$logformat            = [],
  #$access_log           = [],
  #$coredump_dir         = [],
  #$max_filedesc         = [],
  #$snmp_access          = [],
  #$snmp_port            = [],
  $accept_filter = [],
  $access_log = [],
  $acl = [],
  $acl_uses_indirect_client = 'on',
  $external_acl_type = [],
  $acl_uses_indirect_client = 'on',
  $adaptation_access = 'allow', 
  $adaptation_masterx_shared_names = [],
  $adaptation_meta = [],
  $adaptation_send_client_ip = 'off', 
  $adaptation_send_username = 'off', 
  $adaptation_service_chain = [],
  $adaptation_service_iteration_limit = '16',
  $adaptation_service_set = [],
  $adaptation_uses_indirect_client = 'on',
  $adapted_http_access = 'allow',
  $allow_underscore = 'on',
  $always_direct = [],
  $announce_file = [],
  $announce_host = [],
  $announce_period = [],
  $announce_port = '3131', 
  $append_domain = [],
  $as_whois_server = [],
  $auth_param = [], 
  $authenticate_cache_garbage_interval = '1 hour',
  $authenticate_ip_ttl = '1 second',
  $authenticate_ttl = '1 hour', 
  $background_ping_rate = '10 seconds',
  $balance_on_multiple_ip = 'off',
  $broken_posts = [],
  $buffered_logs = 'off',
  $authenticate_cache_garbage_interval = '1 hour',
  $cache = [],
  $cache_dir = [],
  $cache_dns_program = [],
  $cache_effective_group = [],
  $cache_effective_user = 'nobody',
  $cache_log = '/usr/local/squid/var/logs/cache.log',
  $cache_mem = '256 MB', 
  $cache_mgr = 'webmaster',
  $cache_miss_revalidate = 'on',
  $cache_peer = [],
  $cache_peer_access = [],
  $cache_peer_domain = [],
  $cache_replacement_policy = 'lru',
  $cache_store_log = [],
  $cache_swap_high = '95',
  $cache_swap_low = '90',
  $cache_swap_state = [],
  $cachemgr_passwd = [],
  $fqdncache_size = '1024', 
  $ipcache_high = '95',
  $ipcache_low = '90',
  $ipcache_size	 = '1024',
  $memory_cache_mode = [],
  $memory_cache_shared = 'on',
  $sslproxy_session_cache_size = [],
  $cache_dir = [],
  $cache_dns_program = [],
  $cache_effective_group = [],
  $cache_effective_user = 'nobody',
  $cache_log = '/usr/local/squid/var/logs/cache.log',
  $cache_mem = '256 MB', 
  $cache_mgr = 'webmaster',
  $cache_miss_revalidate = 'on',
  $cache_peer = [],
  $cache_peer_access = [],
  $cache_peer_domain = [],
  $cache_peer_access = [],
  $cache_peer_domain = [],
  $cache_replacement_policy = 'lru',
  $cache_store_log = [],
  $cache_swap_high = '95',
  $cache_swap_low = '90',
  $cache_swap_state = [],
  $cachemgr_passwd = [],
  $check_hostnames = 'off', 
  $chroot = [],
  $chunked_request_body_max_size = '64 KB',
  $client_db = 'on',
  $client_delay_access = [],
  $client_delay_initial_bucket_level = '50',
  $client_delay_parameters = [],
  $client_delay_pools = '0', 
  $client_dst_passthru = 'on',
  $client_idle_pconn_timeout = '2 minutes',
  $client_ip_max_connections = 'No limit', 
  $client_lifetime = '1 day',
  $client_netmask = [],
  $client_persistent_connections = 'on',
  $client_request_buffer_max_size = '512 KB',
  $clientside_mark = [],
  $clientside_tos = [],
  $connect_retries = [],
  $connect_timeout = '1 minute', 
  $icap_connect_timeout = [],
  $peer_connect_timeout = '30 seconds',
  $coredump_dir = [],
  $cpu_affinity_map = [],
  $dead_peer_timeout = '10 seconds',
  $debug_options = [],
  $client_delay_access = [],
  $delay_access = [],
  $delay_class = [], 
  $client_delay_initial_bucket_level = '50',
  $delay_initial_bucket_level = '50',
  $client_delay_parameters = [],
  $delay_parameters = [], 
  $delay_pool_uses_indirect_client = 'on',
  $client_delay_pools = '0', 
  $delay_pools = '0',
  $deny_info = [],
  $detect_broken_pconn = 'off',
  $digest_bits_per_entry = '5', 
  $digest_generation = 'on',
  $digest_rebuild_chunk_percentage = '10',
  $digest_rebuild_period = '1 hour', 
  $digest_rewrite_period = '1 hour',
  $digest_swapout_chunk_size = '4096 bytes',
  $diskd_program = [],
  $dns_children = [],
  $dns_defnames = [],
  $dns_nameservers = [],
  $dns_packet_max = [],
  $dns_retransmit_interval = [],
  $dns_timeout = [],
  $dns_v4_first = 'off',
  $ecap_enable = 'off',
  $ecap_service = [],
  $email_err_data = 'on',
  $err_html_text = [],
  $err_page_stylesheet = [],
  $error_default_language = [],
  $error_directory = [],
  $error_log_languages = 'on',
  $esi_parser = 'custom',
  $eui_lookup = 'on', 
  $external_acl_type = [],
  $follow_x_forwarded_for = [],
  $forward_max_tries = '25',
  $forward_timeout = '4 minutes', 
  $follow_x_forwarded_for = [],
  $forwarded_for = 'on', 
  $fqdncache_size = '1024', 
  $ftp_eprt = 'on',
  $ftp_epsv = [],
  $ftp_epsv_all = 'off',
  $ftp_epsv_all = 'off',
  $ftp_passive = 'on',
  $ftp_sanitycheck = 'on',
  $ftp_telnet_protocol = 'on',
  $ftp_user = [],
  $global_internal_static = 'on',
  $half_closed_clients = 'off', 
  $high_memory_warning = [],
  $high_page_fault_warning = [],
  $high_response_time_warning = [],
  $host_verify_strict = 'off',
  $hostname_aliases = [],
  $hosts_file = '/etc/hosts',
  $htcp_access = [],
  $htcp_clr_access = [],
  $htcp_port = '3128', 
  $http_accel_surrogate_remote = [],
  $adapted_http_access = 'allow',
  $http_access = [],
  $http_port = [],
  $http_reply_access = 'allow',
  $httpd_accel_surrogate_id = [],
  $httpd_suppress_version_string = 'off',
  $https_port = [],
  $icap_206_enable = 'on',
  $icap_access = [],
  $icap_class = [],
  $icap_client_username_encode = 'off',
  $icap_client_username_header = 'X-Client-Username',
  $icap_connect_timeout = [],
  $icap_default_options_ttl = '60',
  $icap_enable = 'off',
  $icap_io_timeout = [],
  $icap_log = [],
  $icap_persistent_connections = 'on',
  $icap_preview_enable = 'on',
  $icap_preview_size = 'deny all',
  $icap_retry = [],
  $icap_retry_limit = [],
  $icap_retry_limit = [],
  $icap_service = [],
  $icap_service_failure_limit = '10',
  $icap_service_revival_delay = '180',
  $icap_service_failure_limit = '10',
  $icap_service_revival_delay = '180',
  $icon_directory = [],
  $icp_access = [],
  $icp_hit_stale = 'off',
  $icp_port = [],
  $icp_query_timeout = [],
  $maximum_icp_query_timeout = '2000',
  $mcast_icp_query_timeout = '2000', 
  $minimum_icp_query_timeout = '5',
  $ident_lookup_access = [],
  $ident_timeout = '10 seconds', 
  $ie_refresh = 'off',
  $ignore_unknown_nameservers = 'on',
  $ipcache_high = '95',
  $ipcache_low = '90',
  $ipcache_size	 = '1024',
  $loadable_modules = [],
  $log_access = [],
  $log_icap = [],
  $log_icp_queries = 'on',
  $log_mime_hdrs = 'off',
  $log_uses_indirect_client = 'on',
  $logfile_daemon = [],
  $logfile_rotate = '10',
  $logformat = [],
  $mail_from = [],
  $mail_program = 'mail',
  $max_filedescriptors = [],
  $max_open_disk_fds = [],
  $max_stale = '1 week',
  $maximum_icp_query_timeout = '2000',
  $maximum_object_size = '4 MB',
  $maximum_object_size_in_memory = '512 KB',
  $maximum_object_size_in_memory = '512 KB',
  $mcast_groups = [],
  $mcast_icp_query_timeout = '2000', 
  $mcast_miss_addr = [],
  $mcast_miss_encode_key = [],
  $mcast_miss_port = '3135',
  $mcast_miss_ttl = '16',
  $memory_cache_mode = [],
  $memory_cache_shared = 'on',
  $memory_pools = 'on',
  $memory_pools_limit = '5 MB',
  $memory_pools_limit = '5 MB',
  $memory_replacement_policy = 'lru',
  $mime_table = [],
  $minimum_direct_hops = '4',
  $minimum_direct_rtt = '400',
  $minimum_expiry_time = '60 seconds',
  $minimum_icp_query_timeout = '5',
  $minimum_object_size = [],
  $miss_access = [],
  $negative_dns_ttl = '1 minutes',
  $negative_ttl = '0 seconds',
  $neighbor_type_domain = [],
  $netdb_filename = [],
  $netdb_high = '1000',
  $netdb_low = '900',
  $netdb_ping_period = '5 minutes',
  $never_direct = [],
  $nonhierarchical_direct = 'on',
  $offline_mode = 'off',
  $peer_connect_timeout = '30 seconds',
  $persistent_connection_after_error = 'on',
  $pid_filename = [],
  $pinger_enable = 'on',
  $pinger_program = [],
  $pipeline_prefetch = [],
  $positive_dns_ttl = '6 hours',
  $prefer_direct = 'off',
  $qos_flows = [],
  $query_icmp = 'off',
  $quick_abort_max = '16 KB', 
  $quick_abort_min = '16 KB',
  $quick_abort_pct = '95',
  $range_offset_limit = [],
  $read_ahead_gap = '16 KB',
  $read_timeout = '15 minutes',
  $refresh_all_ims = 'off',
  $refresh_pattern = [],
  $relaxed_header_parser = 'on',
  $reload_into_ims = 'off',
  $reply_body_max_size = [],
  $reply_header_access = [],
  $reply_header_max_size = '64 KB',
  $reply_header_replace = [],
  $chunked_request_body_max_size = '64 KB',
  $request_body_max_size = [],
  $request_entities = 'off',
  $request_header_access = [],
  $request_header_add = [],
  $request_header_max_size = [],
  $request_header_replace = [],
  $persistent_request_timeout = '2 minutes',
  $request_timeout = '5 minutes',
  $retry_on_error = 'off',
  $server_idle_pconn_timeout = '1 minute',
  $server_persistent_connections = 'on',
  $short_icon_urls = 'on',
  $shutdown_lifetime = '30 seconds',
  $sleep_after_fork = '0',
  $snmp_access = [],
  $snmp_incoming_address = [],
  $snmp_outgoing_address = [],
  $snmp_port = [],
  $ssl_bump = [],
  $ssl_engine = [],
  $ssl_unclean_shutdown = 'off',
  $sslcrtd_children = '32 startup=5 idle=1',
  $sslcrtd_program = [],
  $sslpassword_program = [],
  $sslproxy_cafile = [],
  $sslproxy_capath = [],
  $sslproxy_cert_adapt = [],
  $sslproxy_cert_error = [],
  $sslproxy_cert_sign = [],
  $sslproxy_cipher = [],
  $sslproxy_client_certificate = [],
  $sslproxy_client_key = [],
  $sslproxy_flags = [],
  $sslproxy_options = [],
  $sslproxy_version = [],
  $store_avg_object_size = '13 KB',
  $store_dir_select_algorithm = 'least-load',
  $store_objects_per_bucket = '20',
  $strip_query_terms = '20',
  $tcp_outgoing_address = [],
  $tcp_outgoing_mark = [],
  $tcp_outgoing_tos = [],
  $tcp_recv_bufsize = [],
  $test_reachability = 'off',
  $tproxy_uses_indirect_client = 'off',
  $udp_incoming_address = [],
  $udp_outgoing_address = [],
  $umask = '027',
  $unique_hostname = [],
  $unlinkd_program = [],
  $uri_whitespace = 'strip',
  $url_rewrite_access = [],
  $url_rewrite_bypass = 'off',
  $url_rewrite_children = '20 startup=0 idle=1 concurrency=0',
  $url_rewrite_host_header = 'on',
  $url_rewrite_program = [],
  $vary_ignore_expire = 'off',
  $via = 'on',
  $visible_hostname = [],
  $wccp2_address = [],
  $wccp2_assignment_method = 'hash',
  $wccp2_forwarding_method = 'gre',
  $wccp2_rebuild_wait = 'on',
  $wccp2_return_method = 'gre',
  $wccp2_router = [],
  $wccp2_service = [],
  $wccp2_service_info = [],
  $wccp2_service_info = [],
  $wccp2_weight = '10000',
  $wccp_address = [],
  $wccp_router = [],
  $wccp_version = '4',
  $windows_ipaddrchangemonitor = 'on',
  $workers = [],
  $write_timeout = '15 minutes',
) inherits ::squid3::params {

  $use_template = $template ? {
    'short' => 'squid3/squid.conf.short.erb',
    'long'  => 'squid3/squid.conf.long.erb',
    default => $template,
  }

  if ! empty($config_hash) and $use_template == 'long' {
    fail('$config_hash does not (yet) work with the "long" template!')
  }


  package { 'squid3_package': ensure => installed, name => $package_name }

  service { 'squid3_service':
    enable    => true,
    name      => $service_name,
    ensure    => running,
    restart   => "service ${service_name} reload",
    path      => ['/sbin', '/usr/sbin'],
    hasstatus => true,
    require   => Package['squid3_package'],
  }

  file { $config_file:
    require => Package['squid3_package'],
    notify  => Service['squid3_service'],
    content => template($use_template),
  }

}

